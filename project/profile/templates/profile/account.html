{% extends 'base.html' %}

{% block title %}Profilo{% endblock %}


{% block content %}<!-- Start content -->
{% include 'navbar.html' %}
{% load static %}
<div class="container-fluid">
  <div class="row">
    <!-- Start sidebar -->
    <div id="sidebar" class="col-lg-2 d-flex flex-column flex-shrink-0 p-5 h-100">
      <ul class="nav nav-pills flex-column mb-auto"> 
        <li class="nav-item border-bottom py-2"> <!-- start home item -->
          <a href="{% url 'view_browse' %}" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-house-door" viewBox="0 0 16 16">
              <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146ZM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5Z"/>
            </svg>
            Home
          </a>
        </li> <!-- end home item -->

        <li class="nav-item border-bottom py-2"> <!-- start avatar item -->
          <a href="#sectionAvatar" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-bounding-box" viewBox="0 0 16 16">
              <path d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5z"/>
              <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm8-9a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
            </svg>
            Avatar</a>
        </li><!-- end avatar item -->

        <li class="nav-item border-bottom py-2"> <!-- start comments item -->
          <a href="#sectionComments" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
              <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
            </svg>
            Commenti</a>
        </li><!-- end comments item -->

        <li class="nav-item border-bottom py-2"> <!-- start review item -->
          <a href="#sectionReviews" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
              <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z"/>
            </svg>
            Recensioni</a>
        </li><!-- end review item -->

        <li class="nav-item border-bottom py-2"> <!-- start history item -->
          <a href="#sectionHistory" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
              <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"/>
              <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
              <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
            </svg>
            History</a>
        </li><!-- end history item -->

        <li class="nav-item border-bottom py-2"> <!-- start sicurezza item -->
          <a href="#sectionSecurity" class="nav-link" aria-current="page">
            <svg  xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-key" viewBox="0 0 16 16">
              <path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z"/>
              <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
            </svg>
            Sicurezza</a>
        </li><!-- end sicurezza item -->

        <li class="nav-item border-bottom py-2"> <!-- start subscription item -->
          <a href="#sectionSubscription" class="nav-link" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-credit-card" viewBox="0 0 16 16">
              <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z"/>
              <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z"/>
            </svg>
            Abbonamento
          </a>
        </li><!-- end subscription item -->

        <li class="nav-item border-bottom py-2"> <!-- start elimina account item -->
          <a href="#sectionDelAccount" class="nav-link text-danger" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
            </svg>
            Elimina account</a>
        </li><!-- end elimina account item -->
      </ul> 
    </div><!-- End sidebar -->
    
    <div class="col-lg-10 border-start">
      <div class="container py-5">
        {% include 'alert.html' %}

        <div id="sectionAvatar" class="card border-0"><!-- Start avatar card  -->
          <h4>Immagine profilo</h4>
          <div class="row g-0"> <!-- image -->
            <div class="col-md-4">
              <img 
              {% if user_profile.avatar %}
                src="{{ user_profile.avatar.url }}" 
              {% else %}
                src="{% get_media_prefix %}avatars/default.jpg" 
              {% endif %} 
              class="img-fluid rounded-start" width="250"height="250">
              
            </div><!-- end image -->
            <div class="col-md-8">
              <div class="card-body"> <!-- select avatar -->
                <form action="{% url 'view_profile' %}?action=update-avatar" method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  <label class="form-label">Seleziona immagine</label>
                  <input class="form-control" type="file" name="fileAvatar" required>
                  <button class="btn btn-primary mt-2" type="submit">Salva</button>
                </form>
              </div><!-- end select avatar -->
            </div>
          </div>
        </div><!-- End avatar card -->
        
        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionComments" class="card border-0"> <!-- Start i tuoi commenti -->
          <div class="card-body ">
            <h4 class="card-title">I tuoi commenti</h4>
            {% if comments %}
            <ul class="list-group">
              {% for comment in comments %}
              <li class="list-group-item border-0">
                <h6 class="fw-bold">{{ comment.title }}</h6>
                <p>{{ comment.text }}</p>
                <button class="btn btn-danger" onclick="deleteComment('{{ comment.id }}')">Elimina</button>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="card-text">Non ci sono commenti</p>
            {% endif %}
          </div>
        </div><!-- End i tuoi commenti -->
        
        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionReviews" class="card border-0"> <!-- Start le tue recensioni -->
          <div class="card-body ">
            <h4 class="card-title">Le tue recensioni</h4>
            {% if reviews %}
            <ul class="list-group">
              {% for review in reviews %}
              <li class="list-group-item border-0">
                <h6 class="fw-bold">{{ review.title }}</h6>
                <p>Voto {{ review.rating }}/5</p>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="card-text">Non ci sono recensioni</p>
            {% endif %}
          </div>
        </div><!-- End le tue recensioni -->
        
        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionHistory" class="card border-0"> <!-- Start history -->
          <div class="card-body ">
            <h4 class="card-title">Il tuo storico</h4>
            <ul class="list-group">
              <li class="list-group-item border-0">
                {% for item in history %}
                <div class="card border-0">
                  <div class="row g-0">
                    <div class="col-md-2">
                      <img src="{% get_media_prefix %}thumbs/{{ item.title.thumb }}" class="img-fluid h-100 w-100">
                    </div>
                    <div class="col-md-10">
                      <div class="card-body">
                        <h5 class="card-title">{{ item.title.name }}</h5>
                        <p class="card-text"><small class="text-muted">{{ item.date }}</small></p>
                        <p class="card-text">
                          <a href="{% url 'view_details' item.title.id %}" class="text-decoration-none">Vai alla pagina</a>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mb-3"></div>
                {% endfor %}
              </li>
            </ul>
          </div>
        </div><!-- End history -->

        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionSecurity" class="card border-0"> <!-- Start aggiorna password -->
          <div class="card-body">
            <h4 class="card-title">Aggiorna password</h4>
            {% load crispy_forms_tags %}
            <form action="{% url 'view_profile' %}?action=update-password" method="post">
              {% csrf_token %}
              {{ update_password_form|crispy }}
              <button class="btn btn-primary mt-3" type="submit">Modifica</button>
            </form>
          </div>
        </div><!-- End aggiorna password -->

        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionSubscription" class="card border-0"> <!-- Start subscription  -->
          <div class="card-body">
            <h4 class="card-title">Il tuo abbonamento</h4>
            <div class="mb-3"></div>
            
            <select class="form-select mb-3" id="select-subscription" onchange="enableConfButton();" hidden>
              {% for sub in subscription_list %}
                <option value="{{ sub.type }}">{{ sub.type }} (€{{ sub.cost }})</option>
              {% endfor %}
            </select>
            
            {% if not user_subscription %}
            <button class="btn btn-link card-link text-decoration-none" onclick="addNewSubscriptionBtn(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Aggiungi
            </button>

            <button class="btn btn-success" onclick="confirmNewSubscription()" id="btn-confirm-sub" disabled hidden>Conferma</button>
            {% else %}

            <p class="card-text">Stato: 
              {% if user_subscription.is_active %}attivo{% else %}non attivo{% endif %}
            </p>
            <p class="card-text">Tipo: {{ user_subscription.subscription.type }}</p>
            <p class="card-text">Costo: €{{ user_subscription.subscription.cost }}</p>
            
            <button class="btn btn-danger" onclick="deactivateSub()">Disattiva</button>
            {% endif %}

          </div>
        </div><!-- End subscription -->
        
        <div class="mb-5"></div><hr><div class="mb-5"></div>

        <div id="sectionDelAccount" class="card border-0"> <!-- Start elimina account -->
          <div class="card-body">
            <h4 class="card-title">Elimina account</h4>

            {% load crispy_forms_tags %}
            <form action="{% url 'view_profile' %}?action=delete-account" method="post">
              {% csrf_token %}             
              {{ delete_account_form|crispy }}
              <button class="btn btn-danger" type="submit">Elimina</button>
            </form>

          </div>
        </div><!-- End elimina account -->
      
      </div>
    </div>
  </div>
</div>
{% endblock %} <!-- End content -->


{% block script %}<!-- Start script -->
<script>
  $(document).ready(function(){
    $('input[type=password]').each(function(index, elem){
      $(this).blur();
    });
    $('input[type=text]').each(function(index, elem){
      $(this).blur();
    });
  });

  function deleteComment(comment_id){
    $.ajax({
      url     : `{% url 'view_profile' %}?action=delete-comment&comment-id=${comment_id}`,
      method  : "POST",
      data    : { csrfmiddlewaretoken : '{{ csrf_token }}' },
      datatype: "json",
      success : function(data){
        location.reload();
      },
      error : function(data){
        const message = data.message;
        alert(message);
      }
    });
  }

  function addNewSubscriptionBtn(button){
    $(button).prop('hidden', true);
    $('#select-subscription').prop('hidden', false);
    $('#btn-confirm-sub').prop('hidden', false);
  }

  function enableConfButton(){
    $('#btn-confirm-sub').prop('disabled', false);
  }

  function confirmNewSubscription(){
    const subscriptionType = $('#select-subscription').find(':selected').val();

    $.ajax({
      url     : `{% url 'view_profile' %}?action=new-subscription&type=${subscriptionType}`,
      method  : "POST",
      data    : { csrfmiddlewaretoken : '{{ csrf_token }}' },
      datatype: "json",
      success : function(data){
        location.reload();
      },
      error : function(data){
        const message = data.message;
        alert(message);
      }
    });
  }

  function deactivateSub(){
    $.ajax({
      url     : `{% url 'view_profile' %}?action=deactivate-subscription`,
      method  : "POST",
      data    : { csrfmiddlewaretoken : '{{ csrf_token }}' },
      datatype: "json",
      success : function(data){
        location.reload();
      },
      error : function(data){
        const message = data.message;
        alert(message);
      }
    });
  }

  function activateSub(){
    $.ajax({
      url     : `{% url 'view_profile' %}?action=activate-subscription`,
      method  : "POST",
      data    : { csrfmiddlewaretoken : '{{ csrf_token }}' },
      datatype: "json",
      success : function(data){
        location.reload();
      },
      error : function(data){
        const message = data.message;
        alert(message);
      }
    });
  }

</script>
{% endblock %}<!-- End script -->