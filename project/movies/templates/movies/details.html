{% extends 'base.html' %}

{% block title %}Details{% endblock %}

{% block content %}<!-- Start content -->
{% include "navbar.html" %}<!-- Navbar -->

<div class="container py-5">
  
  {% include 'alert.html' %}
  
  <h1>{{ title.name }}</h1>

  <ul class="list-group">
    {% if user.is_authenticated %}
    <li class="list-group-item px-0 border-0">
      {% if is_favorite %}
        <button class="btn btn-danger" onclick="ajaxEvent('{{ title.id }}', 'remove')">Rimuovi dai preferiti</button>
      {% else %}
        <button class="btn btn-success" onclick="ajaxEvent('{{ title.id }}', 'add')">Aggiungi ai preferiti</button>
      {% endif %}
    </li>
    {% endif %}

    <li class="list-group-item px-0  border-0"><u>Valutazione:</u>
      <i>
        {% if not rating_avg %}
          0/5 (nessuna recensione)
        {% else %}
          {{ rating_avg }}/5 ({{ num_reviews }} recensioni)
        {% endif %}
      </i>
    </li>
    <li class="list-group-item px-0  border-0"><u>Data di rilascio:</u> <i>{{ title.release_date }}</i></li>
    <li class="list-group-item px-0  border-0"><u>Genere:</u> <i>{{ title.genre }}</i></li>

    {% if title.type == "film" %}
      <li class="list-group-item px-0  border-0"><u>Durata:</u> <i>{{ film.video.duration }} minuti</i> </li>
      <li class="list-group-item px-0  border-0"><u>Regista:</u> <i>{{ film.director }}</i></li>
    {% endif %}

    {% if title.type == "serie" %}
      <li class="list-group-item px-0  border-0"><u>Numero stagioni:</u> <i>{{ serie.seasons }}</i></li>
    {% endif %}

    <li class="list-group-item px-0  border-0"><p><u>Descrizione:</u> <i>{{ title.description }}</i></p></li>

    {% load static %}
    <li class="list-group-item px-0 border-0">
      <img src="{% get_media_prefix %}{{ title.thumb.thumb_src }}" style="height: 200px;">
    </li>

    {% if title.type == "film" %}
    <li class="list-group-item px-0  border-0">
      <a class="btn btn-primary" href="{% url 'view_watch' title.id %}" target="_blank" rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-play-circle" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
        </svg>
        guarda ora
      </a>
    </li>
    {% endif %}
  </ul>

  {% if title.type == "serie" %}
  <div class="mt-5 mb-5"></div>
  <div class="card border-0">
    <div class="card-body px-0">
      <ul class="list-group list-group-flush">
      {% for season in seasons_range %}
      <li class="list-group-item px-0 border-0"><b>Stagione {{ season }}</b></li>
      
      <ol class="list-group list-group-flush list-group-numbered">
      {% for ep in episodes %}
      {% if ep.num_season == season %}
      <li class="list-group-item">
        <a  href="{% url 'view_watch' title.id %}?s={{ ep.num_season }}&ep={{ ep.num_ep }}" class="text-decoration-none" target="_blank" 
            rel="noopener noreferrer">{{ ep }}</a>
      </li>
      {% endif %}
      {% endfor %}
      </ol>
      <hr>
      {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  <div class="mt-5 mb-5"></div>
  
  {% if user.is_authenticated %}
  <div class="card border-0"><!-- Sezione rating -->
    <h5 class="card-header">Recensisci titolo</h5>
    <div class="card-body">
      
    {% if can_vote %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="inlineRadioOptions" value="1">
      <label class="form-check-label">1</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="inlineRadioOptions" value="2">
      <label class="form-check-label">2</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="inlineRadioOptions" value="3">
      <label class="form-check-label">3</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="inlineRadioOptions" value="4">
      <label class="form-check-label">4</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="inlineRadioOptions" value="5">
      <label class="form-check-label">5</label>
    </div>
    <button class="btn btn-primary" onclick="vote()">Vota</button>
    
    {% else %}
    <p class="card-text">Hai gi√† votato </p>
    
    {% endif %}
    </div>
  </div><!-- End Sezione rating -->
  <div class="mt-5 mb-5"></div>
  {% endif %}


  <div class="card border-0"> <!-- Sezione commenti -->
    <h5 class="card-header">Sezione commenti</h5>
    
    {% if user.is_authenticated %}
    <div class="card-body">
      <form action="{% url 'view_details' title.id %}?action=add-comment" method="POST">
        {% csrf_token %} 
        <label class="form-label">Aggiungi un commento</label>
        <textarea class="form-control" name="comment-text" rows="3"></textarea>
        <button class="btn btn-primary mt-3 mb-3" type="submit">Aggiungi</button>
      </form>
    </div>
    <hr>
    {% endif %}

    <div class="card-body">
      <ul class="list-group list-group-flush">
        {% for comment in comments %}
        <li class="list-group-item px-0">
          <h6><b>{{ comment.user }}</b> ha commentato:</h6>
          <p>{{ comment.text }}</p>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div><!-- End Sezione commenti -->
    
</div>


{% include "footer.html" %}<!-- Footer-->
{% endblock %}<!-- End content -->

{% block script %}
<script type="text/javascript">
  function ajaxEvent(title_id, action){
    $.ajax({
      url     : `{% url 'view_favorites' %}`,
      method  : "POST",
      data    : { 
        csrfmiddlewaretoken : '{{ csrf_token }}',
        action   : action,
        title_id : title_id
      },
      datatype: "json",
      success : function(data){
        location.reload();
      },
      error : function(data){
        const message = data.message;
        alert(message);
      }
    });
  }


  function vote(){
    const rating = $('input[name="inlineRadioOptions"]:checked').val();
      $.ajax({
        url     : `{% url 'view_details' title.id %}?action=add-vote`,
        method  : "POST",
        data    : { 
          csrfmiddlewaretoken : '{{ csrf_token }}',
          rating : rating
        },
        datatype: "json",
        success : function(data){
          location.reload();
        },
        error : function(data){
          const message = data.message;
          alert(message);
        }
      });
  }
</script>
{% endblock %}

